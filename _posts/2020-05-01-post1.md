---
layout: post
title:  "hontoで買った本をブクログに登録"
categories: Python
---

今年のGWこそは何か生産性のあることをしようと思い立ち、ポートフォリオ的なモノを作ってみる。

まずはこれまでのインプットを整理するために、読んだ本をwebサービスで管理することにした。といっても社会人になってから本はほとんど丸善で買っていたため、持ってる本はすでに[honto][honto]のMy本棚に一覧化されている[^1]。これでもいいっちゃいいけど、通販サイトの延長線上なUIと、やんわりロックインされる感じがモヤるので、書店とは独立したサービスにデータを移す。
  
本棚サービスは[ブクログ][booklog]と[読書メーター][bookmater]がメジャーらしい。今回は以下の理由からブクログを選択した。
- ISBNからの一括インポートに対応
- hontoのMy本棚と連携[^2] [^3]
- 見た目が良い

作ってみたアカウントが[こちら][booklog_mypage]。  

アカウントを作ったところでhontoからの引越開始。My本棚にある130冊を1冊ずつぽちぽち登録するのは大変ダルいので、ブクログの「まとめて登録 (ISBN)」機能を使う。ISBNのリストを画面に貼り付けるとブクログ本棚に一括登録してくれるらしい。便利。
  
hontoのMy本棚からISBNを取得する手順は以下:
1. hontoのMy本棚ページを開く
2. 1.からリンクを踏んで書籍情報ページを開く
3. 書籍情報ページ内のISBNを拾う

これを130回繰り返すのはしんどいので、webスクレイピングもどきでやってみる。  
全自動化できたらかっこいいんだけど、今回は自分のスキルの範囲内でできることをやる。  

My本棚を開いてリスト表示に切り替え、ブラウザの機能でページのhtmlファイルを取得する。URLは`https://honto.jp/my/shelf?dsptp=2`。デフォルトの表示形式だとhtmlに書籍情報ページ（後述）へのリンクが含まれないのでリスト表示への切替は必須。複数ページにまたがる場合は全ページ分をぽちぽち取得する。今回は表示件数を50件にして3ぽちぽち。 適当に`books_1.html`, `books_2.html`, `books_3.html`としておく。  
  
（当然ここらへんも自動化できるが、ログイン情報の取扱いを調べるのサボって手作業で済ませた）

次に、集めたhtmlファイルからISBNを取り出す。ファイル内にある書籍情報ページへのリンクを踏み、飛んだ先のページにあるISBNを取得する。  
  
ここでやっと自動化（なぜなら書籍情報ページはログインなしで開ける！）。シェルでお手軽に行く。メインの処理は以下:
1. My本棚のhtmlファイルから書籍情報ページのURLにマッチするURLをgrep
2. curlに流してページ取得
3. 取得したページからISBNをgrep
  
書籍情報ページのURLは`https://honto.jp/netstore/pd-book_(8桁数字).html`の形式であることを調べて、以下のワンライナー(?)でリスト取得:

```
cat books_{1,2,3}.html | \
grep -oE https://honto.jp/netstore/pd-book_.+.html | \ # サボり正規表現
sort | uniq | \ # 同じURLが2回出てくるのでダブりを除去
curl -v --silent $(cat) 2>&1 | \
grep -oE 'ISBN：[0-9-]+' | \
sed 's/ISBN：//' # 余分を切り落とす
> ISBN_list.txt
```

あとは`ISBN_list.txt`の中身をブクログの「まとめて登録 (ISBN)」画面に貼り付ければ完了。一度に登録できる上限が100冊なので、超える場合は何回かぽちぽちする必要あり。  
<br />
<br />
以下、感想。  
ISBN+タイトル+タグ、ぐらいのjsonフォーマット作って自己管理→時々で流行ってるwebサービスにインポート、みたいな運用を考えたけど、そこまでコストかけたいものでもない。  

そもそも本を電子で持って、管理情報もコンテンツそのものも同一サービス内にあれば一番便利。でも、現状のデジタルコンテンツはサービス内の「貸出」にすぎない[^4]から、特定のサービスにどっぷりハマるのは抵抗がある。意地張ってないでKindleの軍門に降るのが一番コスパいいんだろうとは思ってるんだけどね...  
<br />
<br />

[^1]: 丸善でアプリを提示して買えば勝手にMy本棚に追加される。便利！
[^2]: [ブクログ本棚連携機能](https://help.honto.jp/?p=4021195)
[^3]: 同期されるのは連携「後」の本だけ...
[^4]: [私たちはいつになったら電子書籍を”買う”ことができるのか｜inuro｜note](https://note.com/inuro/n/n1ca91934fafa)
[booklog]: http://booklog.jp/
[bookmater]: https://bookmeter.com/
[honto]: https://honto.jp/
[booklog_mypage]: https://booklog.jp/users/tskkom/

